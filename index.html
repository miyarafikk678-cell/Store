<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cheesy Order System</title>
<style>
body { margin:0; font-family:Arial, sans-serif; background:#f0f0f0; }
#loginPage { display:flex; justify-content:center; align-items:center; height:100vh; }
#loginContainer { background:white; padding:30px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); width:300px; }
#loginContainer input { width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }
#loginContainer button { width:100%; padding:10px; background:#ff6600; color:white; border:none; border-radius:5px; cursor:pointer; }
#loginContainer button:hover { background:#e65c00; }

#adminDashboard, #userDashboard { display:none; }
.sidebar { height:100vh; width:220px; position:fixed; top:0; left:0; background-color:#ff6600; padding-top:20px; color:white; display:flex; flex-direction:column; }
.sidebar button { background:none; border:none; color:white; padding:15px 20px; text-align:left; width:100%; cursor:pointer; font-size:16px; }
.sidebar button:hover { background-color:#e65c00; }
.main { margin-left:220px; padding:20px; }
.hidden { display:none; }
input, select, textarea { width:100%; padding:10px; margin:5px 0 15px 0; border-radius:5px; border:1px solid #ccc; }
button.submitBtn { background-color:#ff6600; color:white; border:none; padding:10px 20px; cursor:pointer; border-radius:5px; }
button.submitBtn:hover { background-color:#e65c00; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:10px; border:1px solid #ccc; text-align:left; }
.order-date { margin-top:15px; font-weight:bold; }
@media(max-width:768px) { .sidebar { width:100%; height:auto; position:relative; flex-direction:row; overflow-x:auto; } .sidebar button { flex:1; text-align:center; padding:10px; } .main { margin-left:0; } }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div id="loginContainer">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard">
  <div class="sidebar">
    <button onclick="showAdminSection('orders')">See Orders</button>
    <button onclick="showAdminSection('branches')">Create Branches</button>
    <button onclick="showAdminSection('users')">Create Users</button>
    <button onclick="showAdminSection('items')">Manage Items</button>
    <button onclick="showAdminSection('reports')">Reports</button>
    <button onclick="logout()">Logout</button>
  </div>
  <div class="main">
    <div id="orders" class="section hidden">
      <h2>Orders</h2>
      <label>Date: <input type="date" id="adminOrderDateFilter" onchange="renderAdminOrders()"></label>
      <label>Branch: <select id="adminOrderBranchFilter" onchange="renderAdminOrders()"><option value="">All Branches</option></select></label>
      <div id="ordersTableContainer"></div>
    </div>
    <div id="branches" class="section hidden">
      <h2>Create Branch</h2>
      <input type="text" id="branchName" placeholder="Branch Name">
      <button class="submitBtn" onclick="createBranch()">Add Branch</button>
      <ul id="branchList"></ul>
    </div>
    <div id="users" class="section hidden">
      <h2>Create User</h2>
      <input type="text" id="newUsername" placeholder="Username">
      <input type="password" id="newPassword" placeholder="Password">
      <select id="branchSelect"><option value="">Select Branch</option></select>
      <button class="submitBtn" onclick="createUser()">Add User</button>
      <ul id="userList"></ul>
    </div>
    <div id="items" class="section hidden">
      <h2>Manage Items</h2>
      <input type="text" id="itemName" placeholder="Item Name">
      <input type="text" id="itemUnit" placeholder="Unit">
      <button class="submitBtn" onclick="createItem()">Add Item</button>
      <ul id="itemList"></ul>
    </div>
    <div id="reports" class="section hidden">
      <h2>Reports</h2>
      <label>User: <select id="reportUserFilter" onchange="renderReports()"><option value="">All Users</option></select></label>
      <label>Branch: <select id="reportBranchFilter" onchange="renderReports()"><option value="">All Branches</option></select></label>
      <div id="reportContent"></div>
    </div>
  </div>
</div>

<!-- USER DASHBOARD -->
<div id="userDashboard">
  <div class="sidebar">
    <button onclick="showUserSection('userOrders')">My Orders</button>
    <button onclick="showUserSection('placeOrder')">Place Order</button>
    <button onclick="logout()">Logout</button>
  </div>
  <div class="main">
    <div id="userOrders" class="section hidden">
      <h2>My Orders</h2>
      <label>Date: <input type="date" id="userOrderDateFilter" onchange="renderUserOrders()"></label>
      <div id="userOrdersTableContainer"></div>
    </div>
    <!-- UPDATED PLACE ORDER SECTION -->
    <div id="placeOrder" class="section hidden">
      <h2>Place Order</h2>
      <p id="currentDate"></p>
      <select id="itemSelect"><option value="">Select Item</option></select>
      <input type="number" id="orderQuantity" placeholder="Quantity">
      <button class="submitBtn" onclick="addToCart()">Add to Cart</button>

      <h3>Order Cart</h3>
      <table id="cartTable" style="margin-top:10px; width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="submitBtn" onclick="submitCart()" style="margin-top:10px;">Submit Order</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = "https://yrsxneflvjehttaralyz.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlyc3huZWZsdmplaHR0YXJhbHl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0ODg3OTAsImV4cCI6MjA3NDA2NDc5MH0.pZusEI_4v3S38yghZ9YVQ6bxEtL9KODI6MMou8zxz90";
const db = supabase.createClient(supabaseUrl, supabaseKey);

let loggedUser = null;
let orderCart = [];
// LOGIN
document.getElementById("loginBtn").addEventListener("click", async () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  if (username === "Cheesy" && password === "Cheesy123") {
    loggedUser = { id: "admin", role: "admin", username };
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("adminDashboard").style.display = "block";
    loadAdminData();
    return;
  }

  const { data, error } = await db
    .from("users")
    .select("*")
    .eq("username", username)
    .eq("password", password)
    .single();

  if (error || !data) {
    alert("Invalid login");
    return;
  }

  loggedUser = { id: data.id, role: "user", username: data.username, branch: data.branch_id };
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("userDashboard").style.display = "block";
  loadUserData();
});

// LOGOUT
function logout() {
  loggedUser = null;
  document.getElementById("loginPage").style.display = "flex";
  document.getElementById("adminDashboard").style.display = "none";
  document.getElementById("userDashboard").style.display = "none";
}

// SHOW ADMIN SECTIONS
function showAdminSection(id) {
  document.querySelectorAll("#adminDashboard .section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// SHOW USER SECTIONS
function showUserSection(id) {
  document.querySelectorAll("#userDashboard .section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// CREATE BRANCH
async function createBranch() {
  const name = document.getElementById("branchName").value.trim();
  if (!name) return;
  await db.from("branches").insert([{ name }]);
  loadAdminData();
}

// CREATE USER
async function createUser() {
  const username = document.getElementById("newUsername").value.trim();
  const password = document.getElementById("newPassword").value.trim();
  const branch_id = document.getElementById("branchSelect").value;
  if (!username || !password || !branch_id) return;
  await db.from("users").insert([{ username, password, branch_id }]);
  loadAdminData();
}

// CREATE ITEM
async function createItem() {
  const name = document.getElementById("itemName").value.trim();
  const unit = document.getElementById("itemUnit").value.trim();
  if (!name || !unit) return;
  await db.from("items").insert([{ name, unit }]);
  loadAdminData();
}

// CART FUNCTIONS
function addToCart() {
  const itemId = document.getElementById("itemSelect").value;
  const qty = parseInt(document.getElementById("orderQuantity").value);
  if (!itemId || !qty || qty <= 0) return;

  const itemName = document.getElementById("itemSelect").selectedOptions[0].text;
  orderCart.push({ item_id: itemId, name: itemName, quantity: qty });

  renderCart();
  document.getElementById("orderQuantity").value = "";
  document.getElementById("itemSelect").value = "";
}

function renderCart() {
  const tbody = document.querySelector("#cartTable tbody");
  tbody.innerHTML = "";
  orderCart.forEach((c, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.quantity}</td>
        <td><button onclick="removeCartItem(${i})">Remove</button></td>
      </tr>`;
  });
}

function removeCartItem(index) {
  orderCart.splice(index, 1);
  renderCart();
}

async function submitCart() {
  if (orderCart.length === 0) {
    alert("Cart is empty!");
    return;
  }
  const today = new Date().toISOString().split("T")[0];
  for (const item of orderCart) {
    await db.from("orders").insert([{
      user_id: loggedUser.id,
      branch_id: loggedUser.branch,
      item_id: item.item_id,
      quantity: item.quantity,
      date: today,
      status: "pending"
    }]);
  }
  orderCart = [];
  renderCart();
  alert("Order submitted!");
  renderUserOrders();
}

// LOAD ADMIN DATA
async function loadAdminData() {
  const { data: branches } = await db.from("branches").select("*");
  document.getElementById("branchList").innerHTML = branches.map(b => `<li>${b.name}</li>`).join("");
  document.getElementById("branchSelect").innerHTML = `<option value="">Select Branch</option>` + branches.map(b => `<option value="${b.id}">${b.name}</option>`).join("");
  document.getElementById("adminOrderBranchFilter").innerHTML = `<option value="">All Branches</option>` + branches.map(b => `<option value="${b.id}">${b.name}</option>`).join("");
  document.getElementById("reportBranchFilter").innerHTML = `<option value="">All Branches</option>` + branches.map(b => `<option value="${b.id}">${b.name}</option>`).join("");

  const { data: users } = await db.from("users").select("*");
  document.getElementById("userList").innerHTML = users.map(u => `<li>${u.username}</li>`).join("");
  document.getElementById("reportUserFilter").innerHTML = `<option value="">All Users</option>` + users.map(u => `<option value="${u.id}">${u.username}</option>`).join("");

  const { data: items } = await db.from("items").select("*");
  document.getElementById("itemList").innerHTML = items.map(i => `<li>${i.name} (${i.unit})</li>`).join("");
}

// LOAD USER DATA
async function loadUserData() {
  const { data: items } = await db.from("items").select("*");
  document.getElementById("itemSelect").innerHTML = `<option value="">Select Item</option>` + items.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join("");
  renderUserOrders();
  document.getElementById("currentDate").innerText = "Today: " + new Date().toISOString().split("T")[0];
}

// RENDER USER ORDERS
async function renderUserOrders() {
  const filterDate = document.getElementById("userOrderDateFilter").value;
  let query = db.from("orders").select("*, items(name), branches(name)").eq("user_id", loggedUser.id).order("date");
  if (filterDate) query = query.eq("date", filterDate);
  const { data: orders } = await query;

  const container = document.getElementById("userOrdersTableContainer");
  container.innerHTML = "";

  if (!orders || orders.length === 0) {
    container.innerHTML = "<p>No orders found.</p>";
    return;
  }

  let grouped = {};
  orders.forEach(o => {
    if (!grouped[o.date]) grouped[o.date] = [];
    grouped[o.date].push(o);
  });

  for (let date in grouped) {
    container.innerHTML += `<div class="order-date">${date}</div>`;
    container.innerHTML += `
      <table>
        <tr><th>Item</th><th>Quantity</th><th>Status</th><th>Action</th></tr>
        ${grouped[date].map(o => `
          <tr>
            <td>${o.items.name}</td>
            <td>${o.quantity}</td>
            <td>${o.status}</td>
            <td>
              ${o.status === "sent" ? `<button onclick="markReceived(${o.id})">Mark Received</button>` : ""}
            </td>
          </tr>`).join("")}
      </table>`;
  }
}

// RENDER ADMIN ORDERS
async function renderAdminOrders() {
  const filterDate = document.getElementById("adminOrderDateFilter").value;
  const branchFilter = document.getElementById("adminOrderBranchFilter").value;
  let query = db.from("orders").select("*, items(name), users(username), branches(name)").order("date");
  if (filterDate) query = query.eq("date", filterDate);
  if (branchFilter) query = query.eq("branch_id", branchFilter);
  const { data: orders } = await query;

  const container = document.getElementById("ordersTableContainer");
  container.innerHTML = "";

  if (!orders || orders.length === 0) {
    container.innerHTML = "<p>No orders found.</p>";
    return;
  }

  let grouped = {};
  orders.forEach(o => {
    if (!grouped[o.date]) grouped[o.date] = [];
    grouped[o.date].push(o);
  });

  for (let date in grouped) {
    container.innerHTML += `<div class="order-date">${date}</div>`;
    container.innerHTML += `
      <table>
        <tr><th>User</th><th>Branch</th><th>Item</th><th>Qty</th><th>Status</th><th>Action</th></tr>
        ${grouped[date].map(o => `
          <tr>
            <td>${o.users.username}</td>
            <td>${o.branches.name}</td>
            <td>${o.items.name}</td>
            <td>${o.quantity}</td>
            <td>${o.status}</td>
            <td>
              ${o.status === "pending" ? `
                <button onclick="editOrder(${o.id}, ${o.quantity})">Edit</button>
                <button onclick="markSent(${o.id})">Mark Sent</button>
              ` : ""}
            </td>
          </tr>`).join("")}
      </table>`;
  }
}

// EDIT ORDER
async function editOrder(orderId, currentQty) {
  const newQty = prompt("Enter new quantity:", currentQty);
  if (!newQty || isNaN(newQty)) return;
  await db.from("orders").update({ quantity: parseInt(newQty) }).eq("id", orderId);
  renderAdminOrders();
}

// MARK SENT
async function markSent(orderId) {
  await db.from("orders").update({ status: "sent" }).eq("id", orderId);
  renderAdminOrders();
  renderUserOrders();
}

// MARK RECEIVED
async function markReceived(orderId) {
  await db.from("orders").update({ status: "received" }).eq("id", orderId);
  renderUserOrders();
}

// REPORTS
async function renderReports() {
  const userFilter = document.getElementById("reportUserFilter").value;
  const branchFilter = document.getElementById("reportBranchFilter").value;
  let query = db.from("orders").select("*, users(username), items(name), branches(name)");
  if (userFilter) query = query.eq("user_id", userFilter);
  if (branchFilter) query = query.eq("branch_id", branchFilter);
  const { data: orders } = await query;

  const container = document.getElementById("reportContent");
  container.innerHTML = "";

  if (!orders || orders.length === 0) {
    container.innerHTML = "<p>No data found.</p>";
    return;
  }

  let grouped = {};
  orders.forEach(o => {
    if (!grouped[o.date]) grouped[o.date] = [];
    grouped[o.date].push(o);
  });

  for (let date in grouped) {
    container.innerHTML += `<div class="order-date">${date}</div>`;
    container.innerHTML += `
      <table>
        <tr><th>User</th><th>Branch</th><th>Item</th><th>Qty</th><th>Status</th></tr>
        ${grouped[date].map(o => `
          <tr>
            <td>${o.users.username}</td>
            <td>${o.branches.name}</td>
            <td>${o.items.name}</td>
            <td>${o.quantity}</td>
            <td>${o.status}</td>
          </tr>`).join("")}
      </table>`;
  }
}
</script>
</body>
</html>